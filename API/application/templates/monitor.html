<title>User Detail</title>
<head>
    <title>Flask-SocketIO Test</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function() {
            var socket = io.connect('http://0.0.0.0:8000');

            function uuid4() {
              var uuid = "", i, random;
              for (i = 0; i < 32; i++) {
                random = Math.random() * 16 | 0;

                if (i == 8 || i == 12 || i == 16 || i == 20) {
                  uuid += "-"
                }
                uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
              }
              return uuid;
            }

            socket.on('connect', function() {
                $("#idlogs").text("Connected");
                {% if monitor.subscribing %}
                  var deviceid = [];
                  $('.device').each(function( index ) {
                    deviceid.push($( this ).attr('id'));
                  });
                  socket.emit('startRabbit', {'data': deviceid, 'id': uuid4() });
                {% endif %}
            });

            socket.on('consume', function(data) {
              json = JSON.parse(data)
              hasil = ''
              json.forEach(function(entry) {
                {% for m in monitor.subscribingoid %}
                if (entry.id === '{{ m.id }}' ) {
                  hasil = hasil + '<li>' + entry.oidname + ' : ' + entry.snmpresult + '</li>'
                }
                {% endfor %}
              });
              console.log(json);
              $('.snmpresult').each(function() {
                if (this.id === json[0].deviceid) {
                  $(this).html(hasil)
                }
              });
            });
        });
    </script>
</head>
<p>Hello, {{ session['username'] }}!</p>
<h1>Here come the detail!</h1>
<p>Websocket: <span id="idlogs">Not Connected</span></p>
<ul>
  {% if monitor.subscribing %}
  {% for subscribing in monitor.subscribing %}
  <p class="device" id="{{subscribing.id}}">{{subscribing.name}} ({{subscribing.type}})</p>
  <a href="{{ request.url_root }}devices/{{ subscribing.id }}">Info</a>
  <ul class="snmpresult" id="{{ subscribing.id }}">
  </ul>
  {% endfor %}
  {% else %}
  <p>No Device Subscribed</p>
  {% endif %}
</ul>
